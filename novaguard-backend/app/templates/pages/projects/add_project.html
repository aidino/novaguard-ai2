{% extends "layout/base.html" %}

{% block content %}
<div class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-2xl mx-auto">
    <h1 class="text-2xl font-semibold text-nv-dark mb-6 border-b pb-4">Add New GitHub Project</h1>

    {% if error_github %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
        <p class="font-bold">GitHub Connection Note</p>
        <p>{{ error_github }} 
            <a href="{{ url_for('api_github_oauth_redirect') }}" class="font-semibold hover:underline">Connect/Refresh GitHub Account</a>
        </p>
    </div>
    {% endif %}

    {% if github_connected %}
    <div class="mb-6 p-4 bg-gray-50 rounded-md border">
        <label for="github_repo_select" class="block text-sm font-medium text-gray-700 mb-1">
            Select from your GitHub Repositories (Recommended)
        </label>
        <select id="github_repo_select" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm" disabled>
            <option value="" selected disabled>Loading repositories...</option>
        </select>
        <p id="loading_repos_message" class="mt-1 text-xs text-gray-500"></p>
    </div>
    <hr class="my-6">
    <p class="text-sm text-gray-600 mb-4 text-center">
        {% if prefill_data and prefill_data.repo_name %} {# Kiểm tra prefill_data có tồn tại và có repo_name không #}
            Review the prefilled details below or select a different repository above.
        {% else %}
            Or fill the details manually:
        {% endif %}
    </p>
    {% else %}
     <p class="text-sm text-gray-600 mb-4 text-center">
        Please connect your GitHub account on the Dashboard to easily select your repositories. Otherwise, you can fill the details manually:
    </p>
    {% endif %}


    <form action="{{ url_for('ui_add_project_post') }}" method="post" class="space-y-6">
        <div>
            <label for="repo_name" class="block text-sm font-medium text-gray-700 mb-1">
                Repository Name <span class="text-red-500">*</span> <span class="text-xs text-gray-500">(Format: `owner/repository-name`)</span>
            </label>
            <input type="text" name="repo_name" id="repo_name" required 
                   value="{{ prefill_data.repo_name if prefill_data else '' }}"
                   placeholder="your-github-username/your-repo-name"
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm">
            <p class="mt-1 text-xs text-gray-500">This must be the full name of the repository on GitHub (e.g., MyOrg/my-cool-repo).</p>
        </div>

        <div>
            <label for="github_repo_id" class="block text-sm font-medium text-gray-700 mb-1">
                GitHub Repository ID <span class="text-red-500">*</span> <span class="text-xs text-gray-500">(Numeric ID from GitHub)</span>
            </label>
            <input type="text" name="github_repo_id" id="github_repo_id" required 
                   value="{{ prefill_data.repo_id if prefill_data else '' }}"
                   placeholder="e.g., 123456789"
                   pattern="[0-9]+" title="Please enter a numeric GitHub Repository ID."
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm">
            <p class="mt-1 text-xs text-gray-500">
                This is the unique numerical ID for the repository from GitHub, not the repository name.
            </p>
        </div>

        <div>
            <label for="main_branch" class="block text-sm font-medium text-gray-700 mb-1">
                Main Branch <span class="text-red-500">*</span> <span class="text-xs text-gray-500">(e.g., `main`, `master`, `develop`)</span>
            </label>
            <input type="text" name="main_branch" id="main_branch" 
                   value="{{ prefill_data.main_branch if prefill_data else 'main' }}" required
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm">
        </div>

        <div>
            <label for="language" class="block text-sm font-medium text-gray-700 mb-1">
                Primary Language (Optional)
            </label>
            <input type="text" name="language" id="language" placeholder="e.g., Python, JavaScript, Java"
                   value="" {# Bỏ prefill cho language và notes nếu không có trong prefill_data #}
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm">
        </div>

        <div>
            <label for="custom_project_notes" class="block text-sm font-medium text-gray-700 mb-1">
                Custom Project Notes (Optional)
            </label>
            <textarea name="custom_project_notes" id="custom_project_notes" rows="4"
                      placeholder="Any specific coding conventions, architectural guidelines, or important notes for the LLM to consider during analysis."
                      class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-nv-accent focus:border-nv-accent sm:text-sm"></textarea>
        </div>

        <div class="flex justify-end pt-4">
            <a href="{{ url_for('ui_dashboard_get') }}" class="mr-3 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nv-accent">
                Cancel
            </a>
            <button type="submit"
                    class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-nv-accent hover:bg-nv-accent-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-nv-accent-dark">
                Add Project & Setup Webhook
            </button>
        </div>
    </form>
</div>

{% if github_connected %} {# Chỉ chạy script nếu người dùng đã kết nối GitHub (biến này được truyền từ route /add) #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const repoSelect = document.getElementById('github_repo_select');
    const repoNameInput = document.getElementById('repo_name');
    const repoIdInput = document.getElementById('github_repo_id');
    const mainBranchInput = document.getElementById('main_branch');
    const loadingReposMessage = document.getElementById('loading_repos_message');

    // Lấy giá trị prefill ban đầu từ context của Jinja2
    // (Những giá trị này sẽ là None nếu người dùng vào trang /add trực tiếp mà không có query params)
    const initialPrefillRepoId = "{{ prefill_data.repo_id or '' }}";
    const initialPrefillRepoName = "{{ prefill_data.repo_name or '' }}";
    // main_branch đã có value="{{ prefill_data.main_branch or 'main' }}" trong input rồi

    function populateSelectWithOptions(repos) {
        if(!repoSelect) return; // Kiểm tra repoSelect tồn tại
        if(loadingReposMessage) loadingReposMessage.style.display = 'none';
        
        // Xóa các option cũ (ví dụ: "Loading...")
        while (repoSelect.firstChild && (repoSelect.firstChild.disabled || repoSelect.firstChild.value === "")) {
            repoSelect.removeChild(repoSelect.firstChild);
        }
        
        let defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "-- Select a Repository --";
        repoSelect.appendChild(defaultOption);

        if (repos && repos.length > 0) {
            repos.forEach(repo => {
                let option = document.createElement('option');
                option.value = repo.id; 
                option.textContent = repo.full_name; 
                option.dataset.fullName = repo.full_name;
                option.dataset.repoId = repo.id; 
                option.dataset.defaultBranch = repo.default_branch || 'main';
                
                // Nếu ID này trùng với initialPrefillRepoId (từ URL query params) thì chọn nó
                if (initialPrefillRepoId && String(repo.id) === initialPrefillRepoId) {
                    option.selected = true;
                }
                repoSelect.appendChild(option);
            });
            repoSelect.disabled = false;
            // Nếu có prefill từ URL, tự động trigger 'change' để điền form lần đầu
            if (initialPrefillRepoId && repoSelect.value === initialPrefillRepoId) {
                repoSelect.dispatchEvent(new Event('change'));
            } else {
                defaultOption.selected = true; // Chọn lại option mặc định nếu không có prefill khớp
            }

        } else {
            defaultOption.textContent = "No repositories found or unable to fetch.";
            repoSelect.disabled = false; 
        }
    }
    
    if (repoSelect) { 
        if(loadingReposMessage) loadingReposMessage.textContent = 'Loading your GitHub repositories...';
        repoSelect.disabled = true;

        // Gọi route UI mới để lấy repo, không phải API /api/projects/github-repos
        fetch("{{ url_for('ui_list_gh_repos_for_form') }}") 
            .then(response => {
                if (response.status === 401) {
                     throw new Error('Unauthorized to fetch repositories. Please ensure you are logged in.');
                }
                if (!response.ok) {
                    return response.json().then(err_data => {
                        throw new Error(err_data.detail || 'Failed to load repositories. Status: ' + response.status);
                    }).catch(() => {
                        throw new Error('Failed to load repositories. Status: ' + response.status + ' ' + response.statusText);
                    });
                }
                return response.json();
            })
            .then(repos => {
                populateSelectWithOptions(repos);
            })
            .catch(error => {
                console.error('Error fetching GitHub repos for UI form:', error);
                if(loadingReposMessage) loadingReposMessage.textContent = 'Could not load repositories: ' + error.message;
                if(loadingReposMessage) loadingReposMessage.classList.add('text-red-500');
                
                while (repoSelect.firstChild && (repoSelect.firstChild.disabled || repoSelect.firstChild.value === "")) {
                    repoSelect.removeChild(repoSelect.firstChild);
                }
                let errorOption = document.createElement('option');
                errorOption.value = "";
                errorOption.textContent = "Error loading repositories.";
                errorOption.selected = true;
                errorOption.disabled = true;
                repoSelect.appendChild(errorOption);
                repoSelect.disabled = false;
            });

        repoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) { 
                repoNameInput.value = selectedOption.dataset.fullName;
                repoIdInput.value = selectedOption.dataset.repoId;
                mainBranchInput.value = selectedOption.dataset.defaultBranch;
            } else {
                // Nếu chọn lại "-- Select --", xóa các trường (hoặc giữ giá trị prefill từ URL nếu có)
                repoNameInput.value = initialPrefillRepoName; // Giữ lại prefill ban đầu nếu có
                repoIdInput.value = initialPrefillRepoId;     // Giữ lại prefill ban đầu nếu có
                mainBranchInput.value = "{{ prefill_data.main_branch or 'main' }}"; // Giữ lại prefill hoặc default
            }
        });
    } else if (!github_connected && loadingReposMessage) { 
        loadingReposMessage.textContent = 'Connect to GitHub on Dashboard to select repositories from this list.';
    } else if (loadingReposMessage && !github_connected) {
        // Nếu không có select box (vì github_connected=false) và có loading message
        loadingReposMessage.style.display = 'none'; // Ẩn thông báo loading
    }
});
</script>
{% endif %} {# Kết thúc if github_connected cho script #}

{% endblock %}